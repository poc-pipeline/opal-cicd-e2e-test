name: 'Generate Gate Summary'
description: 'Generates a GitHub step summary for gate evaluation results'

inputs:
  decision:
    description: 'Gate decision (PASS, PASS_WITH_EXCEPTION, BLOCKED)'
    required: true
  exit-code:
    description: 'Exit code from gate evaluation'
    required: true
  reason:
    description: 'Reason for the decision'
    required: true
  critical:
    description: 'Number of critical vulnerabilities'
    required: true
  high:
    description: 'Number of high vulnerabilities'
    required: true
  medium:
    description: 'Number of medium vulnerabilities'
    required: true
  low:
    description: 'Number of low vulnerabilities'
    required: true
  quality-gate-status:
    description: 'SonarQube quality gate status'
    required: false
    default: 'UNKNOWN'
  bugs:
    description: 'Number of bugs'
    required: false
    default: '0'
  code-smells:
    description: 'Number of code smells'
    required: false
    default: '0'
  coverage:
    description: 'Test coverage percentage'
    required: false
    default: '0'
  security-rating:
    description: 'Security rating (A-E)'
    required: false
    default: 'Unknown'
  reliability-rating:
    description: 'Reliability rating (A-E)'
    required: false
    default: 'Unknown'

runs:
  using: 'composite'
  steps:
    - name: Generate summary
      shell: bash
      run: |
        DECISION="${{ inputs.decision }}"
        EXIT_CODE="${{ inputs.exit-code }}"
        REASON="${{ inputs.reason }}"

        # Determine icon based on decision
        if [ "$DECISION" = "PASS" ]; then
          ICON="âœ…"
          STATUS_COLOR="green"
        elif [ "$DECISION" = "PASS_WITH_EXCEPTION" ]; then
          ICON="âš ï¸"
          STATUS_COLOR="yellow"
        else
          ICON="âŒ"
          STATUS_COLOR="red"
        fi

        # Generate the summary
        cat >> $GITHUB_STEP_SUMMARY << EOF
        ## $ICON Policy Gate Evaluation

        | Metric | Value |
        |--------|-------|
        | **Decision** | **$DECISION** |
        | Exit Code | $EXIT_CODE |
        | Reason | $REASON |

        ### ðŸ”’ Security Metrics (Snyk)

        | Severity | Count | Status |
        |----------|-------|--------|
        EOF

        # Add security metrics with status indicators
        CRITICAL="${{ inputs.critical }}"
        HIGH="${{ inputs.high }}"
        MEDIUM="${{ inputs.medium }}"
        LOW="${{ inputs.low }}"

        if [ "$CRITICAL" -gt 0 ]; then
          echo "| ðŸ”´ Critical | **$CRITICAL** | âŒ Blocking |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸ”´ Critical | $CRITICAL | âœ… None |" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "$HIGH" -gt 0 ]; then
          echo "| ðŸŸ  High | **$HIGH** | âš ï¸ Review Required |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸŸ  High | $HIGH | âœ… None |" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "$MEDIUM" -gt 0 ]; then
          echo "| ðŸŸ¡ Medium | $MEDIUM | â„¹ï¸ Informational |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸŸ¡ Medium | $MEDIUM | âœ… None |" >> $GITHUB_STEP_SUMMARY
        fi

        echo "| âšª Low | $LOW | âœ… OK |" >> $GITHUB_STEP_SUMMARY

        # Add quality metrics
        QG_STATUS="${{ inputs.quality-gate-status }}"
        BUGS="${{ inputs.bugs }}"
        CODE_SMELLS="${{ inputs.code-smells }}"
        COVERAGE="${{ inputs.coverage }}"
        SECURITY_RATING="${{ inputs.security-rating }}"
        RELIABILITY_RATING="${{ inputs.reliability-rating }}"

        if [ "$QG_STATUS" = "PASSED" ] || [ "$QG_STATUS" = "OK" ]; then
          QG_ICON="âœ…"
          QG_DISPLAY="$QG_STATUS"
        elif [ "$QG_STATUS" = "FAILED" ] || [ "$QG_STATUS" = "ERROR" ]; then
          QG_ICON="âŒ"
          QG_DISPLAY="$QG_STATUS"
        elif [ "$QG_STATUS" = "NONE" ]; then
          QG_ICON="âšª"
          QG_DISPLAY="Not Configured"
        else
          QG_ICON="â“"
          QG_DISPLAY="$QG_STATUS"
        fi

        # Determine rating icons
        get_rating_icon() {
          case "$1" in
            A) echo "âœ…" ;;
            B) echo "âœ…" ;;
            C) echo "âš ï¸" ;;
            D) echo "âŒ" ;;
            E) echo "âŒ" ;;
            *) echo "â“" ;;
          esac
        }

        SEC_ICON=$(get_rating_icon "$SECURITY_RATING")
        REL_ICON=$(get_rating_icon "$RELIABILITY_RATING")

        cat >> $GITHUB_STEP_SUMMARY << EOF

        ### ðŸ“Š Quality Metrics (SonarQube)

        | Metric | Value |
        |--------|-------|
        | Quality Gate | $QG_ICON **$QG_DISPLAY** |
        | Security Rating | $SEC_ICON **$SECURITY_RATING** |
        | Reliability Rating | $REL_ICON **$RELIABILITY_RATING** |
        | Coverage | ${COVERAGE}% |
        | Bugs | $BUGS |
        | Code Smells | $CODE_SMELLS |

        ---
        *Evaluated by Policy Management System*
        EOF

        echo "Summary generated successfully"
