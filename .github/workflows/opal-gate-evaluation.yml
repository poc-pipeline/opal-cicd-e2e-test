# =============================================================================
# OPAL Security Gate Evaluation Reusable Workflow
# =============================================================================
#
# Evaluates security and quality gates using OPAL (OPA via OPAL).
#
# Features:
#   - Security gates (Snyk vulnerability thresholds)
#   - Quality gates (SonarQube metrics)
#   - Jira exception validation (only bypass mechanism)
#   - Policies from poc-pipeline/cicd-gating-policies
#
# Exit codes:
#   0 - All gates passed or passed with Jira exception
#   1 - Non-blocking warnings
#   2 - Blocked (requires Jira exception)
#
# =============================================================================

name: 'OPAL Security Gate Evaluation'

on:
  workflow_call:
    inputs:
      enable-quality-gates:
        description: 'Enable SonarQube quality gate evaluation'
        required: false
        type: boolean
        default: true
      enable-jira-exceptions:
        description: 'Enable fetching Jira exceptions for gate bypass'
        required: false
        type: boolean
        default: true
      jira-project-key:
        description: 'Jira project key for exceptions'
        required: false
        type: string
        default: 'GATES'

    secrets:
      SNYK_TOKEN:
        required: false
      SONAR_TOKEN:
        required: false
      JIRA_BASE_URL:
        required: false
      JIRA_API_TOKEN:
        required: false
      JIRA_USER_EMAIL:
        required: false
      OPAL_POLICY_REPO_SSH_KEY:
        required: false

    outputs:
      gate-result:
        description: 'Combined gate result (0=pass, 1=warning, 2=blocked)'
        value: ${{ jobs.evaluate-opal-gates.outputs.gate-result }}
      gate-decision:
        description: 'Gate decision (PASS, WARNING, BLOCKED, PASS_WITH_EXCEPTION)'
        value: ${{ jobs.evaluate-opal-gates.outputs.gate-decision }}
      security-gate-result:
        description: 'Security gate result'
        value: ${{ jobs.evaluate-opal-gates.outputs.security-result }}
      quality-gate-result:
        description: 'Quality gate result'
        value: ${{ jobs.evaluate-opal-gates.outputs.quality-result }}
      has-exception:
        description: 'Whether Jira exception was used'
        value: ${{ jobs.evaluate-opal-gates.outputs.has-exception }}

jobs:
  evaluate-opal-gates:
    name: Evaluate OPAL Security Gates
    runs-on: ubuntu-latest

    outputs:
      gate-result: ${{ steps.evaluate-gates.outputs.gate-result }}
      gate-decision: ${{ steps.evaluate-gates.outputs.gate-decision }}
      security-result: ${{ steps.evaluate-gates.outputs.security-result }}
      quality-result: ${{ steps.evaluate-gates.outputs.quality-result }}
      has-exception: ${{ steps.evaluate-gates.outputs.has-exception }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download security results
        uses: actions/download-artifact@v4
        with:
          name: security-results
          path: snyk-scanning/results
        continue-on-error: true

      - name: Download quality results
        if: inputs.enable-quality-gates
        uses: actions/download-artifact@v4
        with:
          name: quality-results
          path: sonarqube-cloud-scanning/results
        continue-on-error: true

      - name: Clone Policy Repository
        id: clone-policies
        env:
          SSH_KEY: ${{ secrets.OPAL_POLICY_REPO_SSH_KEY }}
        run: |
          if [ -n "$SSH_KEY" ]; then
            echo "Cloning from private policy repository..."
            mkdir -p ~/.ssh
            echo "$SSH_KEY" > ~/.ssh/opal_key
            chmod 600 ~/.ssh/opal_key
            ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null

            GIT_SSH_COMMAND="ssh -i ~/.ssh/opal_key -o StrictHostKeyChecking=no" \
              git clone --depth 1 git@github.com:poc-pipeline/cicd-gating-policies.git /tmp/policies-repo

            echo "policy-source=private" >> $GITHUB_OUTPUT
          else
            echo "Cloning public policy repository..."
            git clone --depth 1 https://github.com/poc-pipeline/cicd-gating-policies.git /tmp/policies-repo
            echo "policy-source=public" >> $GITHUB_OUTPUT
          fi

          if [ -d "/tmp/policies-repo/policies" ]; then
            echo "Policy repository cloned successfully"
            echo "POLICY_PATH=/tmp/policies-repo/policies" >> $GITHUB_ENV
            echo "DATA_PATH=/tmp/policies-repo/data" >> $GITHUB_ENV
            ls -la /tmp/policies-repo/policies/
          else
            echo "Policy directory not found"
            exit 1
          fi

      - name: Fetch Jira Exceptions
        id: fetch-jira
        if: inputs.enable-jira-exceptions
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT_KEY: ${{ inputs.jira-project-key }}
        run: |
          if [ -z "$JIRA_API_TOKEN" ] || [ -z "$JIRA_BASE_URL" ] || [ -z "$JIRA_USER_EMAIL" ]; then
            echo "Jira credentials not configured - skipping exception fetch"
            echo '{"exceptions": []}' > /tmp/jira-exceptions.json
            echo "exception-count=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Fetching Jira exceptions for ${{ github.repository }}..."

          chmod +x .github/scripts/fetch-jira-exceptions.sh

          set +e
          ./.github/scripts/fetch-jira-exceptions.sh \
            --app-id "${{ github.repository }}" \
            --output /tmp/jira-exceptions.json \
            --verbose
          FETCH_RESULT=$?
          set -e

          if [ $FETCH_RESULT -eq 0 ] && [ -f /tmp/jira-exceptions.json ]; then
            EXCEPTION_COUNT=$(jq '.exceptions | length' /tmp/jira-exceptions.json 2>/dev/null || echo 0)
            echo "Found $EXCEPTION_COUNT Jira exception(s)"
            echo "exception-count=$EXCEPTION_COUNT" >> $GITHUB_OUTPUT

            if [ "$EXCEPTION_COUNT" -gt 0 ]; then
              echo "Exception details:"
              jq -r '.exceptions[] | "  - \(.ticket_id): \(.gate_id) (expires: \(.expiry_date))"' /tmp/jira-exceptions.json
            fi
          else
            echo "No Jira exceptions found or fetch failed"
            echo '{"exceptions": []}' > /tmp/jira-exceptions.json
            echo "exception-count=0" >> $GITHUB_OUTPUT
          fi

      - name: Start OPA with Policies
        id: start-opa
        run: |
          echo "Starting OPA with policies from: $POLICY_PATH"
          START_TIME=$(date +%s)

          docker run -d \
            --name opa-local \
            -p 8181:8181 \
            -v "${POLICY_PATH}:/policies:ro" \
            -v "${DATA_PATH}:/data:ro" \
            openpolicyagent/opa:latest \
            run --server --addr=0.0.0.0:8181 --log-level=info /policies

          echo "Waiting for OPA to become ready..."
          MAX_WAIT=60
          WAITED=0
          INTERVAL=2

          while [ $WAITED -lt $MAX_WAIT ]; do
            if curl -sf http://localhost:8181/health > /dev/null 2>&1; then
              echo "OPA is ready after ${WAITED}s"
              break
            fi
            sleep $INTERVAL
            WAITED=$((WAITED + INTERVAL))
          done

          END_TIME=$(date +%s)
          STARTUP_TIME=$((END_TIME - START_TIME))
          echo "startup-time=$STARTUP_TIME" >> $GITHUB_OUTPUT

          if [ $WAITED -ge $MAX_WAIT ]; then
            echo "OPA failed to start within ${MAX_WAIT}s"
            docker logs opa-local 2>&1 | tail -20
            exit 1
          fi

          POLICY_COUNT=$(curl -sf http://localhost:8181/v1/policies | jq '.result | length' || echo 0)
          echo "Policies loaded: $POLICY_COUNT"
          echo "policy-count=$POLICY_COUNT" >> $GITHUB_OUTPUT

          if [ "$POLICY_COUNT" -eq 0 ]; then
            echo "No policies loaded - check Rego syntax"
            docker logs opa-local 2>&1 | tail -30
            exit 1
          fi

      - name: Evaluate OPAL Gates
        id: evaluate-gates
        env:
          USER_KEY: ${{ github.actor }}
          DEBUG: 'true'
        run: |
          chmod +x .github/scripts/evaluate-gates.sh

          JIRA_EXCEPTIONS_ARG=""
          if [ -f "/tmp/jira-exceptions.json" ]; then
            EXCEPTION_COUNT=$(jq '.exceptions | length' /tmp/jira-exceptions.json 2>/dev/null || echo 0)
            if [ "$EXCEPTION_COUNT" -gt 0 ]; then
              echo "Including $EXCEPTION_COUNT Jira exception(s) in evaluation"
              JIRA_EXCEPTIONS_ARG="/tmp/jira-exceptions.json"
            fi
          fi

          set +e
          ./.github/scripts/evaluate-gates.sh \
            snyk-scanning/results/snyk-results.json \
            sonarqube-cloud-scanning/results/quality-gate-result.json \
            $JIRA_EXCEPTIONS_ARG
          GATE_RESULT=$?
          set -e

          echo "gate-result=$GATE_RESULT" >> $GITHUB_OUTPUT

          if [ -f /tmp/opa-input.json ]; then
            RESPONSE=$(curl -sf -X POST \
              -H "Content-Type: application/json" \
              -d @/tmp/opa-input.json \
              http://localhost:8181/v1/data/cicd/gating/evaluation_response 2>/dev/null || echo '{}')

            DECISION=$(echo "$RESPONSE" | jq -r '.result.decision // "UNKNOWN"')
            SECURITY_RESULT=$(echo "$RESPONSE" | jq -r '.result.gates.security.exit_code // 0')
            QUALITY_RESULT=$(echo "$RESPONSE" | jq -r '.result.gates.quality.exit_code // 0')
            HAS_EXCEPTION=$(echo "$RESPONSE" | jq -r '.result.exception.has_exception // false')

            echo "gate-decision=$DECISION" >> $GITHUB_OUTPUT
            echo "security-result=$SECURITY_RESULT" >> $GITHUB_OUTPUT
            echo "quality-result=$QUALITY_RESULT" >> $GITHUB_OUTPUT
            echo "has-exception=$HAS_EXCEPTION" >> $GITHUB_OUTPUT
          else
            case $GATE_RESULT in
              0) echo "gate-decision=PASS" >> $GITHUB_OUTPUT ;;
              1) echo "gate-decision=WARNING" >> $GITHUB_OUTPUT ;;
              2) echo "gate-decision=BLOCKED" >> $GITHUB_OUTPUT ;;
              *) echo "gate-decision=UNKNOWN" >> $GITHUB_OUTPUT ;;
            esac
            echo "security-result=$GATE_RESULT" >> $GITHUB_OUTPUT
            echo "quality-result=0" >> $GITHUB_OUTPUT
            echo "has-exception=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate Gate Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## OPAL Security Gate Evaluation Results

          ### Authorization Context
          | Parameter | Value |
          |-----------|-------|
          | GitHub User | ${{ github.actor }} |
          | Repository | ${{ github.repository }} |
          | Policy Engine | OPA via OPAL |
          | Policy Source | ${{ steps.clone-policies.outputs.policy-source || 'public' }} (poc-pipeline/cicd-gating-policies) |
          | Startup Time | ${{ steps.start-opa.outputs.startup-time }}s |
          | Policies Loaded | ${{ steps.start-opa.outputs.policy-count }} |

          ### Gate Results
          | Gate | Result |
          |------|--------|
          | Security Gates | Exit Code: ${{ steps.evaluate-gates.outputs.security-result || 'N/A' }} |
          | Quality Gates | Exit Code: ${{ steps.evaluate-gates.outputs.quality-result || 'N/A' }} |
          | Combined | Exit Code: ${{ steps.evaluate-gates.outputs.gate-result }} |
          | Decision | **${{ steps.evaluate-gates.outputs.gate-decision || 'N/A' }}** |

          ### Jira Exception Status
          | Parameter | Value |
          |-----------|-------|
          | Exceptions Fetched | ${{ steps.fetch-jira.outputs.exception-count || '0' }} |
          | Exception Applied | ${{ steps.evaluate-gates.outputs.has-exception || 'false' }} |

          ### Gate Decision Matrix
          | Exit Code | Status | Description |
          |-----------|--------|-------------|
          | 0 | PASS | All gates passed (or with Jira exception) |
          | 1 | WARNING | Non-blocking issues detected |
          | 2 | BLOCKED | Requires Jira exception to proceed |

          EOF

      - name: Stop OPA
        if: always()
        run: |
          docker stop opa-local 2>/dev/null || true
          docker rm opa-local 2>/dev/null || true

      - name: Enforce Gate Decision
        run: |
          GATE_RESULT=${{ steps.evaluate-gates.outputs.gate-result }}

          case "$GATE_RESULT" in
            0)
              echo "Deployment authorized"
              ;;
            1)
              echo "Warning: Non-blocking issues detected"
              ;;
            2)
              echo "Deployment blocked - Jira exception required"
              exit 2
              ;;
            *)
              echo "Unknown result"
              exit 2
              ;;
          esac
