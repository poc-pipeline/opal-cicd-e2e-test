name: Docker Build

on:
  workflow_call:
    inputs:
      image-name:
        description: 'Docker image name'
        required: false
        type: string
        default: 'e2e-test-app'
      image-tag:
        description: 'Docker image tag (defaults to github.sha)'
        required: false
        type: string
        default: ''
      working-directory:
        description: 'Project directory containing Dockerfile'
        required: false
        type: string
        default: 'test-app'

jobs:
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: ./.github/actions/download-build-artifacts
        with:
          artifact-name: build-artifacts
          download-path: ${{ inputs.working-directory }}/target

      - name: Set image tag
        id: set-tag
        run: |
          TAG="${{ inputs.image-tag }}"
          if [ -z "$TAG" ]; then
            TAG="${{ github.sha }}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Image tag: $TAG"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          cd ${{ inputs.working-directory }}

          echo "Building Docker image..."
          docker build \
            --tag ${{ inputs.image-name }}:${{ steps.set-tag.outputs.tag }} \
            --tag ${{ inputs.image-name }}:latest \
            --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
            --build-arg GIT_COMMIT=${{ github.sha }} \
            .

          echo ""
          echo "Docker images built:"
          docker images | grep ${{ inputs.image-name }}

      - name: Save Docker image
        run: |
          echo "Saving Docker image to tar file..."
          docker save ${{ inputs.image-name }}:${{ steps.set-tag.outputs.tag }} > docker-image.tar

          IMAGE_SIZE=$(du -h docker-image.tar | cut -f1)
          echo "Image saved: docker-image.tar ($IMAGE_SIZE)"

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: docker-image.tar
          retention-days: 1

      - name: Generate Docker Build Summary
        run: |
          IMAGE_SIZE=$(du -h docker-image.tar | cut -f1)

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Docker Build Summary

          | Parameter | Value |
          |-----------|-------|
          | Image Name | ${{ inputs.image-name }} |
          | Image Tag | ${{ steps.set-tag.outputs.tag }} |
          | Image Size | $IMAGE_SIZE |
          | Build Status | Success |

          ### Image Details

          \`\`\`
          $(docker inspect ${{ inputs.image-name }}:${{ steps.set-tag.outputs.tag }} --format '{{.Config.Labels}}' 2>/dev/null || echo "No labels")
          \`\`\`

          EOF
