# =============================================================================
# OPAL CI/CD End-to-End Pipeline (Modular)
# =============================================================================
#
# Complete CI/CD pipeline demonstrating policy-based security gating with:
#   - Modular reusable workflows for build, security, and quality
#   - Real Snyk security scanning
#   - Real SonarQube Cloud quality analysis
#   - Gate evaluation using local Policy Management System
#   - Self-hosted runner for local API access
#
# =============================================================================

name: E2E OPAL CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_security_scan:
        description: 'Skip Snyk security scan'
        type: boolean
        default: false
      skip_quality_analysis:
        description: 'Skip SonarQube analysis'
        type: boolean
        default: false

env:
  JAVA_VERSION: '17'

jobs:
  # ===========================================================================
  # Build Application (Reusable Workflow)
  # ===========================================================================
  build:
    name: Build
    uses: ./.github/workflows/build-application.yml
    with:
      java-version: '17'

  # ===========================================================================
  # Security Scanning - Snyk (Reusable Workflow)
  # ===========================================================================
  security-scan:
    name: Security Scan
    needs: build
    if: ${{ !inputs.skip_security_scan }}
    uses: ./.github/workflows/security-scanning.yml
    with:
      java-version: '17'
      run-container-scan: false
    secrets:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      SNYK_ORG_ID: ${{ secrets.SNYK_ORG_ID }}

  # ===========================================================================
  # Quality Analysis - SonarQube (Reusable Workflow)
  # ===========================================================================
  quality-analysis:
    name: Quality Analysis
    needs: build
    if: ${{ !inputs.skip_quality_analysis }}
    uses: ./.github/workflows/quality-analysis.yml
    with:
      java-version: '17'
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
      SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}

  # ===========================================================================
  # Policy Gate Evaluation (Reusable Workflow)
  # ===========================================================================
  gate-evaluation:
    name: Gate Evaluation
    needs: [security-scan, quality-analysis]
    if: always() && needs.build.result == 'success'
    uses: ./.github/workflows/gate-evaluation.yml
    with:
      api-url: 'http://localhost:8000'
      security-results-artifact: 'security-results'
      quality-results-artifact: 'quality-results'
    secrets:
      POLICY_API_KEY: ${{ secrets.POLICY_API_KEY }}

  # ===========================================================================
  # Pipeline Summary
  # ===========================================================================
  summary:
    name: Pipeline Summary
    needs: [build, security-scan, quality-analysis, gate-evaluation]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Generate pipeline summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## Pipeline Execution Summary

          | Stage | Status |
          |-------|--------|
          | Build | ${{ needs.build.result }} |
          | Security Scan | ${{ needs.security-scan.result }} |
          | Quality Analysis | ${{ needs.quality-analysis.result }} |
          | Gate Evaluation | ${{ needs.gate-evaluation.result }} |

          ### Architecture

          This pipeline uses modular reusable workflows:
          - `build-application.yml` - Maven build & test
          - `security-scanning.yml` - Snyk vulnerability scanning
          - `quality-analysis.yml` - SonarQube Cloud analysis
          - `gate-evaluation.yml` - Policy gate evaluation

          Gate evaluation uses these composite actions:
          - `parse-scan-results` - Parse Snyk and SonarQube results
          - `evaluate-policy-gates` - Call Policy Management System API
          - `generate-gate-summary` - Generate GitHub step summary

          Gate evaluation runs on self-hosted runner to access
          local Policy Management System at `http://localhost:8000`.
          EOF
