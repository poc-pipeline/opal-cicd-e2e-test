# =============================================================================
# OPAL CI/CD End-to-End Pipeline (Modular)
# =============================================================================
#
# Complete CI/CD pipeline demonstrating OPAL-based security gating with:
#   - Modular reusable workflows for build, security, quality, and docker
#   - Real Snyk security scanning
#   - Real SonarQube Cloud quality analysis
#   - Real Jira exception management
#   - Policy Management System integration
#   - Policies from poc-pipeline/cicd-gating-policies
#
# =============================================================================

name: E2E OPAL CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_security_scan:
        description: 'Skip Snyk security scan'
        type: boolean
        default: false
      skip_quality_analysis:
        description: 'Skip SonarQube analysis'
        type: boolean
        default: false

env:
  JAVA_VERSION: '17'
  DOCKER_BUILDKIT: 1

jobs:
  # ===========================================================================
  # Build Application (Reusable Workflow)
  # ===========================================================================
  build:
    name: Build
    uses: ./.github/workflows/build-application.yml
    with:
      java-version: '17'
      working-directory: 'test-app'

  # ===========================================================================
  # Security Scanning - Snyk (Reusable Workflow)
  # ===========================================================================
  security-scan:
    name: Security Scan
    needs: build
    if: ${{ !inputs.skip_security_scan }}
    uses: ./.github/workflows/security-scanning.yml
    with:
      java-version: '17'
      working-directory: 'test-app'
    secrets:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  # ===========================================================================
  # Quality Analysis - SonarQube (Reusable Workflow)
  # ===========================================================================
  quality-analysis:
    name: Quality Analysis
    needs: build
    if: ${{ !inputs.skip_quality_analysis }}
    uses: ./.github/workflows/quality-analysis.yml
    with:
      java-version: '17'
      working-directory: 'test-app'
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
      SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}

  # ===========================================================================
  # OPAL Security Gate Evaluation (Reusable Workflow)
  # ===========================================================================
  opal-gate-evaluation:
    name: Gate Evaluation
    needs: [security-scan, quality-analysis]
    if: always() && needs.build.result == 'success'
    uses: ./.github/workflows/opal-gate-evaluation.yml
    with:
      enable-quality-gates: ${{ !inputs.skip_quality_analysis }}
      enable-jira-exceptions: true
    secrets: inherit

  # ===========================================================================
  # Build Docker Image (Reusable Workflow)
  # ===========================================================================
  build-docker:
    name: Docker Build
    needs: opal-gate-evaluation
    if: success()
    uses: ./.github/workflows/docker-build.yml
    with:
      image-name: 'e2e-test-app'
      working-directory: 'test-app'

  # ===========================================================================
  # Local Deployment & Policy Management UI Test
  # ===========================================================================
  local-deployment:
    name: Local Deployment & UI Test
    needs: build-docker
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load < docker-image.tar

      - name: Clone Policy Repository
        env:
          SSH_KEY: ${{ secrets.OPAL_POLICY_REPO_SSH_KEY }}
        run: |
          if [ -n "$SSH_KEY" ]; then
            echo "Cloning from private policy repository..."
            mkdir -p ~/.ssh
            echo "$SSH_KEY" > ~/.ssh/opal_key
            chmod 600 ~/.ssh/opal_key
            ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
            GIT_SSH_COMMAND="ssh -i ~/.ssh/opal_key" \
              git clone --depth 1 git@github.com:poc-pipeline/cicd-gating-policies.git /tmp/policies-repo
          else
            echo "Cloning public policy repository..."
            git clone --depth 1 https://github.com/poc-pipeline/cicd-gating-policies.git /tmp/policies-repo
          fi

      - name: Clone Policy Management System
        env:
          SSH_KEY: ${{ secrets.POLICY_MGMT_SYSTEM_SSH_KEY }}
          OPAL_SSH_KEY: ${{ secrets.OPAL_POLICY_REPO_SSH_KEY }}
        run: |
          if [ -n "$SSH_KEY" ]; then
            echo "Cloning Policy Management System using dedicated SSH key..."
            mkdir -p ~/.ssh
            echo "$SSH_KEY" > ~/.ssh/pms_key
            chmod 600 ~/.ssh/pms_key
            ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
            GIT_SSH_COMMAND="ssh -i ~/.ssh/pms_key" \
              git clone --depth 1 git@github.com:poc-pipeline/policy-management-system.git ../policy-management-system
          elif [ -n "$OPAL_SSH_KEY" ]; then
            echo "Cloning Policy Management System using OPAL SSH key..."
            mkdir -p ~/.ssh
            echo "$OPAL_SSH_KEY" > ~/.ssh/opal_key
            chmod 600 ~/.ssh/opal_key
            ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
            GIT_SSH_COMMAND="ssh -i ~/.ssh/opal_key" \
              git clone --depth 1 git@github.com:poc-pipeline/policy-management-system.git ../policy-management-system
          else
            echo "Cloning Policy Management System using HTTPS..."
            git clone --depth 1 https://github.com/poc-pipeline/policy-management-system.git ../policy-management-system
          fi
          ls -la ../policy-management-system/

      - name: Start Policy Management Stack
        run: |
          export GITHUB_SHA=${{ github.sha }}
          export POLICY_REPO_PATH=/tmp/policies-repo

          if ! docker compose -f policy-management-stack/docker-compose.yml up -d --build 2>&1; then
            echo "Docker Compose failed. Checking logs..."
            docker compose -f policy-management-stack/docker-compose.yml logs --tail=100 || true
            docker ps -a || true
            exit 1
          fi

          echo "Waiting for services to start..."
          sleep 30

          echo "Container status:"
          docker ps -a

          for container in e2e-policy-loader e2e-opa e2e-policy-api e2e-policy-ui e2e-test-app; do
            STATUS=$(docker inspect --format='{{.State.Status}}' $container 2>/dev/null || echo "not_found")
            if [ "$STATUS" = "exited" ]; then
              echo "=== Logs for exited container $container ==="
              docker logs $container 2>&1 | tail -50
            fi
          done

      - name: Health Check - Test Application
        run: |
          echo "Checking Test Application health..."
          for i in {1..30}; do
            if curl -sf http://localhost:8080/actuator/health | jq -e '.status == "UP"'; then
              echo "Test Application is healthy!"
              exit 0
            fi
            echo "Attempt $i/30: Waiting for Test Application..."
            sleep 2
          done
          echo "Test Application health check failed"
          docker logs e2e-test-app 2>&1 | tail -50
          exit 1

      - name: Health Check - OPA
        run: |
          echo "Checking OPA health..."
          for i in {1..20}; do
            if curl -sf http://localhost:8181/health; then
              echo "OPA is healthy!"
              POLICY_COUNT=$(curl -sf http://localhost:8181/v1/policies | jq '.result | length')
              echo "Policies loaded: $POLICY_COUNT"
              exit 0
            fi
            echo "Attempt $i/20: Waiting for OPA..."
            sleep 2
          done
          echo "OPA health check failed"
          docker logs e2e-opa 2>&1 | tail -50
          exit 1

      - name: Health Check - Policy Management API
        run: |
          echo "Checking Policy Management API health..."
          for i in {1..20}; do
            if curl -sf http://localhost:8000/health; then
              echo "Policy Management API is healthy!"
              exit 0
            fi
            echo "Attempt $i/20: Waiting for Policy Management API..."
            sleep 2
          done
          echo "Policy Management API health check failed"
          docker logs e2e-policy-api 2>&1 | tail -50
          exit 1

      - name: Health Check - Policy Management UI
        run: |
          echo "Checking Policy Management UI..."
          for i in {1..20}; do
            if curl -sf http://localhost:3000 > /dev/null; then
              echo "Policy Management UI is accessible!"
              exit 0
            fi
            echo "Attempt $i/20: Waiting for Policy Management UI..."
            sleep 2
          done
          echo "Policy Management UI health check failed"
          docker logs e2e-policy-ui 2>&1 | tail -50
          exit 1

      - name: Test OPA Policy Evaluation
        run: |
          echo "Testing OPA policy evaluation..."

          RESPONSE=$(curl -sf -X POST \
            -H "Content-Type: application/json" \
            -d '{
              "input": {
                "user": {"key": "test-user"},
                "action": "deploy",
                "resource": {
                  "type": "deployment",
                  "key": "test-123",
                  "attributes": {
                    "vulnerabilities": {"critical": 0, "high": 0, "medium": 0, "low": 0},
                    "quality": {"quality_gate": {"status": "OK"}}
                  }
                },
                "context": {"environment": "test", "jira_exceptions": []}
              }
            }' \
            http://localhost:8181/v1/data/cicd/gating/evaluation_response)

          echo "OPA Response: $RESPONSE"

          DECISION=$(echo "$RESPONSE" | jq -r '.result.decision // "UNKNOWN"')
          echo "Gate Decision: $DECISION"

          if [ "$DECISION" = "PASS" ] || [ "$DECISION" = "PASS_WITH_EXCEPTION" ]; then
            echo "OPA policy evaluation working correctly!"
          else
            echo "Warning: Unexpected decision - $DECISION"
          fi

      - name: Cleanup
        if: always()
        run: |
          docker compose -f policy-management-stack/docker-compose.yml down || true
          docker rm -f e2e-test-app e2e-opa e2e-policy-api e2e-policy-ui e2e-policy-loader 2>/dev/null || true

      - name: Generate Deployment Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## Local Deployment Test Results

          | Service | Port | Status |
          |---------|------|--------|
          | Test Application | 8080 | Tested |
          | OPA Policy Engine | 8181 | Tested |
          | Policy Management API | 8000 | Tested |
          | Policy Management UI | 3000 | Tested |

          ### Pipeline Architecture

          This pipeline uses modular reusable workflows:
          - `build-application.yml` - Maven build & test
          - `security-scanning.yml` - Snyk vulnerability scanning
          - `quality-analysis.yml` - SonarQube Cloud analysis
          - `opal-gate-evaluation.yml` - OPA policy-based gating
          - `docker-build.yml` - Docker image creation

          ### Services Deployed
          - Test Application with health endpoint
          - OPA with policies from poc-pipeline/cicd-gating-policies
          - Policy Management System (FastAPI + Vue UI)
          EOF
