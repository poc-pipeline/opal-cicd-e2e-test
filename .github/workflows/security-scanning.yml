name: Security Scanning

on:
  workflow_call:
    inputs:
      java-version:
        description: 'Java version to use'
        required: false
        type: string
        default: '17'
      working-directory:
        description: 'Project directory'
        required: false
        type: string
        default: 'test-app'
    secrets:
      SNYK_TOKEN:
        required: true
    outputs:
      critical-count:
        description: 'Number of critical vulnerabilities'
        value: ${{ jobs.security-scan.outputs.critical-count }}
      high-count:
        description: 'Number of high vulnerabilities'
        value: ${{ jobs.security-scan.outputs.high-count }}
      medium-count:
        description: 'Number of medium vulnerabilities'
        value: ${{ jobs.security-scan.outputs.medium-count }}
      low-count:
        description: 'Number of low vulnerabilities'
        value: ${{ jobs.security-scan.outputs.low-count }}

jobs:
  security-scan:
    name: Snyk Security Scan
    runs-on: ubuntu-latest

    outputs:
      critical-count: ${{ steps.security-summary.outputs.critical-count }}
      high-count: ${{ steps.security-summary.outputs.high-count }}
      medium-count: ${{ steps.security-summary.outputs.medium-count }}
      low-count: ${{ steps.security-summary.outputs.low-count }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java and Maven
        uses: ./.github/actions/setup-java-maven
        with:
          java-version: ${{ inputs.java-version }}
          working-directory: ${{ inputs.working-directory }}

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ${{ inputs.working-directory }}/target
        continue-on-error: true

      - name: Run Snyk Security Test
        uses: snyk/actions/maven@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --file=${{ inputs.working-directory }}/pom.xml --json-file-output=snyk-results.json
          command: test

      - name: Ensure Snyk results file exists
        run: |
          if [ ! -f snyk-results.json ]; then
            echo "Creating empty Snyk results file..."
            echo '{"vulnerabilities":[],"ok":true,"dependencyCount":0}' > snyk-results.json
          fi

          # Validate JSON
          if ! jq empty snyk-results.json 2>/dev/null; then
            echo "Invalid JSON in snyk-results.json, creating empty file"
            echo '{"vulnerabilities":[],"ok":true,"dependencyCount":0}' > snyk-results.json
          fi

          echo "Snyk results file content preview:"
          head -20 snyk-results.json

      - name: Generate security summary
        id: security-summary
        uses: ./.github/actions/generate-security-summary
        with:
          results-file: snyk-results.json
          summary-title: 'Snyk Security Scan Results'

      - name: Upload security results
        uses: actions/upload-artifact@v4
        with:
          name: security-results
          path: snyk-results.json
          retention-days: 1

      - name: Security scan outcome
        run: |
          CRITICAL="${{ steps.security-summary.outputs.critical-count }}"
          HIGH="${{ steps.security-summary.outputs.high-count }}"

          echo "Security Scan Complete"
          echo "  Critical: $CRITICAL"
          echo "  High: $HIGH"

          if [ "$CRITICAL" -gt 0 ]; then
            echo "::warning::Critical vulnerabilities found: $CRITICAL"
          fi

          if [ "$HIGH" -gt 0 ]; then
            echo "::warning::High vulnerabilities found: $HIGH"
          fi
